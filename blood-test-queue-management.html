<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการคิวห้องเจาะเลือด - THAMC</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 24px;
            padding: 50px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 100%;
            text-align: center;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .login-logo svg {
            width: 50px;
            height: 50px;
            color: white;
        }

        .login-card h1 {
            font-size: 28px;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .login-card p {
            font-size: 16px;
            color: #718096;
            margin-bottom: 35px;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-size: 15px;
            color: #2d3748;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 14px 18px;
            font-size: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 45px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            font-weight: 600;
            width: 100%;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        }

        /* Main Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
            background: #f7fafc;
        }

        .dashboard.active {
            display: block;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .logo svg {
            width: 30px;
            height: 30px;
            color: white;
        }

        .header-info h1 {
            font-size: 20px;
            color: #2d3748;
            font-weight: 600;
        }

        .header-info p {
            font-size: 14px;
            color: #718096;
            margin-top: 2px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-details {
            text-align: left;
        }

        .user-name {
            font-size: 14px;
            color: #2d3748;
            font-weight: 600;
        }

        .counter-badge {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
        }

        .btn-logout {
            background: #e2e8f0;
            color: #2d3748;
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: #cbd5e0;
        }

        /* Main Content */
        .main-content {
            display: flex;
            height: calc(100vh - 90px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            padding: 20px 0;
        }

        .menu-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            color: #718096;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #f7fafc;
            color: #667eea;
        }

        .menu-item.active {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-left-color: #667eea;
        }

        .menu-item svg {
            width: 22px;
            height: 22px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon svg {
            width: 26px;
            height: 26px;
            color: white;
        }

        .stat-icon.general {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .stat-icon.wheelchair {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .stat-icon.urgent {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .stat-icon.container {
            background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-label {
            font-size: 14px;
            color: #718096;
            margin-top: 5px;
        }

        /* Queue List */
        .queue-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            background: #f7fafc;
            padding: 6px;
            border-radius: 10px;
        }

        .filter-tab {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: #718096;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .filter-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .queue-table {
            width: 100%;
            border-collapse: collapse;
        }

        .queue-table th {
            background: #f7fafc;
            padding: 15px;
            text-align: left;
            font-size: 14px;
            color: #718096;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }

        .queue-table td {
            padding: 18px 15px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 15px;
            color: #2d3748;
        }

        .queue-table tbody tr:hover {
            background: #f7fafc;
        }

        .queue-number {
            font-weight: 700;
            font-size: 18px;
            color: #667eea;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
        }

        .status-badge.waiting {
            background: #fef5e7;
            color: #d68910;
        }

        .status-badge.called {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-badge.serving {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-badge.completed {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .type-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .type-badge.general {
            background: rgba(72, 187, 120, 0.2);
            color: #38a169;
        }

        .type-badge.wheelchair {
            background: rgba(237, 137, 54, 0.2);
            color: #dd6b20;
        }

        .type-badge.urgent {
            background: rgba(245, 101, 101, 0.2);
            color: #e53e3e;
        }

        .type-badge.container {
            background: rgba(159, 122, 234, 0.2);
            color: #805ad5;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            background: #e2e8f0;
            color: #2d3748;
            white-space: nowrap;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-action svg {
            width: 18px;
            height: 18px;
        }

        .btn-call {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-call:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-view {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-view:hover {
            background: #cbd5e0;
        }

        /* New Patient Detail Page Layout */
        .detail-grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: auto 1fr;
            gap: 25px;
            height: 100%;
        }

        .detail-actions-panel {
            grid-column: 1 / -1;
            background: white;
            border-radius: 12px;
            padding: 12px 18px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            flex-wrap: nowrap;
        }

        .detail-patient-info {
            grid-column: 1 / 2;
            grid-row: 2 / 3;
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .detail-tube-list {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }

        .detail-meta-info {
            grid-column: 3 / 4;
            grid-row: 2 / 3;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .meta-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            flex-grow: 1;
        }

        .meta-section h3, .detail-patient-info h3, .detail-tube-list h3 {
            font-size: 18px;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .action-btn-group {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .timer-display, .channel-display {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 8px 16px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            min-width: 110px;
            flex-shrink: 0;
        }

        .timer-display .label, .channel-display .label {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timer-display .value, .channel-display .value {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .channel-display {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #93c5fd;
        }

        .channel-display .value {
            color: #1e40af;
        }

        .timer-display {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #fcd34d;
        }

        .timer-display .value {
            color: #92400e;
        }

        .patient-info-grid-new {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px;
        }

        .info-item .label {
            font-size: 13px;
            color: #718096;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-size: 15px;
            color: #2d3748;
            font-weight: 500;
        }

        .patient-photo-new {
            width: 100px;
            height: 100px;
            border-radius: 16px;
            object-fit: cover;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .tube-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .tube-action-icon {
            cursor: pointer;
            font-size: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #94a3b8;
            position: relative;
        }

        .tube-action-icon:hover {
            color: #667eea;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.25);
        }

        .tube-action-icon.scanned {
            color: #22c55e;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #86efac;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .tube-action-icon.scanned:hover {
            color: #16a34a;
            border-color: #4ade80;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .tube-action-icon::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 12px;
            padding: 2px;
            background: linear-gradient(135deg, transparent, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tube-action-icon:hover::before {
            opacity: 1;
        }

        /* Settings Page */
        .settings-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .settings-section h3 {
            font-size: 18px;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 15px;
            color: #2d3748;
            font-weight: 500;
        }

        .settings-description {
            font-size: 13px;
            color: #718096;
            margin-top: 5px;
        }

        .counter-select {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            cursor: pointer;
            min-width: 120px;
        }

        .counter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .type-checkboxes {
            display: flex;
            gap: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .checkbox-label:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Patient Details Page */
        .patient-detail-page {
            background: white;
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .patient-detail-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 16px 16px 0 0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .patient-detail-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .patient-detail-title h2 {
            font-size: 24px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-3px);
        }

        .patient-detail-body {
            padding: 40px;
        }

        .detail-section {
            margin-bottom: 40px;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .section-title-detail {
            font-size: 20px;
            color: #2d3748;
            margin-bottom: 25px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 3px solid #e2e8f0;
        }

        .patient-header {
            display: flex;
            gap: 25px;
            margin-bottom: 30px;
            align-items: flex-start;
        }

        .patient-photo {
            flex-shrink: 0;
        }

        .patient-photo img {
            width: 150px;
            height: 150px;
            border-radius: 16px;
            object-fit: cover;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 4px solid white;
        }

        .patient-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            flex: 1;
        }

        .info-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            background: #edf2f7;
            transform: translateX(3px);
        }

        .info-label {
            font-size: 13px;
            color: #718096;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .info-value {
            font-size: 18px;
            color: #2d3748;
            font-weight: 600;
        }

        .action-bar {
            display: flex;
            gap: 15px;
            padding: 30px 40px;
            background: #f7fafc;
            border-radius: 0 0 16px 16px;
            border-top: 2px solid #e2e8f0;
        }

        .action-bar .btn {
            flex: 1;
        }

        /* Blood Tubes Display - Horizontal Realistic Style */
        .tubes-section {
            margin-top: 30px;
        }

        .tubes-section h4 {
            font-size: 16px;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .tubes-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tube-item {
            background: linear-gradient(to bottom, #ffffff 0%, #f9fafb 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .tube-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e0;
        }

        .tube-visual-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .tube-visual {
            flex: 1;
            position: relative;
        }

        /* Horizontal Tube - Beautiful Realistic Design */
        .tube-icon-horizontal {
            width: 100%;
            height: 55px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15), inset 0 2px 5px rgba(255, 255, 255, 0.6);
            background: linear-gradient(
                to bottom,
                rgba(255, 255, 255, 0.95) 0%,
                rgba(248, 250, 252, 0.98) 50%,
                rgba(255, 255, 255, 0.95) 100%
            );
            border: 2px solid rgba(203, 213, 225, 0.6);
        }

        /* Blood inside tube (horizontal flow) */
        .tube-icon-horizontal::before {
            content: '';
            position: absolute;
            left: 35px;
            top: 6px;
            bottom: 6px;
            width: calc(70% - 35px);
            z-index: 1;
            background: linear-gradient(
                to right,
                #dc2626 0%,
                #ef4444 40%,
                #f87171 70%,
                #fca5a5 100%
            );
            border-radius: 7px;
            opacity: 0.92;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.25);
        }

        /* Colored Cap at Left Side */
        .tube-cap-horizontal {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 32px;
            z-index: 2;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.5);
            border-radius: 14px 0 0 14px;
        }

        /* Cap texture/grip (horizontal lines) */
        .tube-cap-horizontal::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 38px;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.18) 0px,
                rgba(0, 0, 0, 0.18) 2px,
                transparent 2px,
                transparent 5px
            );
            border-radius: 2px;
        }

        /* Colored Caps by Type */
        .tube-icon-horizontal.red .tube-cap-horizontal {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        .tube-icon-horizontal.purple .tube-cap-horizontal {
            background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
        }
        .tube-icon-horizontal.green .tube-cap-horizontal {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }
        .tube-icon-horizontal.blue .tube-cap-horizontal {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
        .tube-icon-horizontal.yellow .tube-cap-horizontal {
            background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
        }
        .tube-icon-horizontal.gray .tube-cap-horizontal {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        .tube-icon-horizontal.light-blue .tube-cap-horizontal {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        }
        .tube-icon-horizontal.pink .tube-cap-horizontal {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        }
        .tube-icon-horizontal.orange .tube-cap-horizontal {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        .tube-icon-horizontal.black .tube-cap-horizontal {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }
        .tube-icon-horizontal.white .tube-cap-horizontal {
            background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%);
            border: 1px solid #d1d5db;
        }

        .tube-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tube-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tube-name-detail {
            font-size: 15px;
            color: #1e293b;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tube-volume {
            font-size: 12px;
            color: #6366f1;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            border: 1.5px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 2px 6px rgba(99, 102, 241, 0.15);
        }

        .tube-test-name {
            font-size: 13px;
            color: #475569;
            font-weight: 600;
            line-height: 1.3;
        }

        .tube-details {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
            padding: 2px 0;
        }

        .tube-additives {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 3px;
        }

        .additive-tag {
            font-size: 11px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #475569;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            border: 1.5px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .additive-tag:hover {
            border-color: #cbd5e0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* Print Button */
        .btn-print {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            margin-top: 25px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .patient-header {
                flex-direction: column;
                align-items: center;
            }

            .patient-info-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 10px 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .queue-table {
                font-size: 13px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .tube-item {
                padding: 18px;
            }

            .tube-visual-wrapper {
                flex-direction: column;
                gap: 12px;
            }

            .tube-actions {
                flex-direction: row;
                width: 100%;
                justify-content: center;
            }

            .tube-action-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .tube-icon-horizontal {
                height: 45px;
            }

            .tube-header {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .tube-name-detail {
                font-size: 17px;
            }

            .patient-photo img {
                width: 120px;
                height: 120px;
            }

            .tube-icon-horizontal {
                width: 100px;
                height: 35px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <svg fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19.5 3h-15A1.5 1.5 0 0 0 3 4.5v15A1.5 1.5 0 0 0 4.5 21h15a1.5 1.5 0 0 0 1.5-1.5v-15A1.5 1.5 0 0 0 19.5 3zm-6.75 13.5h-1.5v-3.75H7.5v-1.5h3.75V7.5h1.5v3.75h3.75v1.5h-3.75v3.75z"/>
                </svg>
            </div>
            <h1>ระบบจัดการคิวห้องเจาะเลือด</h1>
            <p>เจ้าหน้าที่เข้าสู่ระบบ</p>

            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">ชื่อผู้ใช้</label>
                    <input type="text" id="username" class="form-input" placeholder="กรอกชื่อผู้ใช้" required>
                </div>

                <div class="form-group">
                    <label for="password">รหัสผ่าน</label>
                    <input type="password" id="password" class="form-input" placeholder="กรอกรหัสผ่าน" required>
                </div>

                <button type="submit" class="btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 22px; height: 22px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                    </svg>
                    เข้าสู่ระบบ
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo">
                    <svg fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19.5 3h-15A1.5 1.5 0 0 0 3 4.5v15A1.5 1.5 0 0 0 4.5 21h15a1.5 1.5 0 0 0 1.5-1.5v-15A1.5 1.5 0 0 0 19.5 3zm-6.75 13.5h-1.5v-3.75H7.5v-1.5h3.75V7.5h1.5v3.75h3.75v1.5h-3.75v3.75z"/>
                    </svg>
                </div>
                <div class="header-info">
                    <h1>ระบบจัดการคิวห้องเจาะเลือด</h1>
                    <p>Thammarat Advanced Medical Center</p>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Admin User</div>
                        <div class="counter-badge">ช่อง <span id="counterNumber">1</span></div>
                    </div>
                </div>
                <button class="btn-logout" onclick="handleLogout()">
                    ออกจากระบบ
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="menu-item active" onclick="showPage('queuePage')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4"></path>
                    </svg>
                    <span>จัดการคิว</span>
                </div>
                <div class="menu-item" onclick="showPage('settingsPage')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span>ตั้งค่า</span>
                </div>
                <div class="menu-item" onclick="showPage('historyPage')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>ประวัติการให้บริการ</span>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Queue Management Page -->
                <div class="page active" id="queuePage">
                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-number" id="statGeneral">12</div>
                                    <div class="stat-label">ผู้ป่วยทั่วไป</div>
                                </div>
                                <div class="stat-icon general">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-number" id="statWheelchair">3</div>
                                    <div class="stat-label">ผู้ป่วยรถเข็น</div>
                                </div>
                                <div class="stat-icon wheelchair">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-number" id="statUrgent">2</div>
                                    <div class="stat-label">ผู้ป่วยเร่งด่วน</div>
                                </div>
                                <div class="stat-icon urgent">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-number" id="statContainer">5</div>
                                    <div class="stat-label">กระปุก</div>
                                </div>
                                <div class="stat-icon container">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Queue List -->
                    <div class="queue-section">
                        <div class="section-header">
                            <h2 class="section-title">รายการคิว</h2>
                            <div class="filter-tabs">
                                <button class="filter-tab active" onclick="filterQueue(this, 'all')">ทั้งหมด</button>
                                <button class="filter-tab" onclick="filterQueue(this, 'waiting')">รอเรียก</button>
                                <button class="filter-tab" onclick="filterQueue(this, 'serving')">กำลังให้บริการ</button>
                                <button class="filter-tab" onclick="filterQueue(this, 'completed')">เสร็จสิ้น</button>
                            </div>
                        </div>

                        <table class="queue-table">
                            <thead>
                                <tr>
                                    <th>หมายเลขคิว</th>
                                    <th>ชื่อผู้ป่วย</th>
                                    <th>HN</th>
                                    <th>ประเภท</th>
                                    <th>สถานะ</th>
                                    <th>เวลาลงทะเบียน</th>
                                    <th>ช่อง</th>
                                    <th>เจ้าหน้าที่</th>
                                    <th>การดำเนินการ</th>
                                </tr>
                            </thead>
                            <tbody id="queueTableBody">
                                <!-- Queue items will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Page -->
                <div class="page" id="settingsPage">
                    <div class="settings-section">
                        <h3>ตั้งค่าช่องบริการ</h3>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">เลือกช่องบริการ</div>
                                <div class="settings-description">กำหนดหมายเลขช่องบริการของคุณ</div>
                            </div>
                            <select class="counter-select" id="counterSelect" onchange="updateCounter()">
                                <option value="1">ช่อง 1</option>
                                <option value="2">ช่อง 2</option>
                                <option value="3">ช่อง 3</option>
                                <option value="4">ช่อง 4</option>
                                <option value="5">ช่อง 5</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>กรองประเภทผู้ป่วย</h3>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">แสดงเฉพาะประเภท</div>
                                <div class="settings-description">เลือกประเภทผู้ป่วยที่ต้องการแสดงในคิว</div>
                            </div>
                            <div class="type-checkboxes">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked onchange="updateQueueFilter()">
                                    <span>ทั่วไป</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" checked onchange="updateQueueFilter()">
                                    <span>รถเข็น</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" checked onchange="updateQueueFilter()">
                                    <span>เร่งด่วน</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" checked onchange="updateQueueFilter()">
                                    <span>กระปุก</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>การแจ้งเตือน</h3>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">เสียงแจ้งเตือน</div>
                                <div class="settings-description">เปิดใช้งานเสียงเมื่อมีคิวใหม่</div>
                            </div>
                            <label class="checkbox-label">
                                <input type="checkbox" checked>
                                <span>เปิดใช้งาน</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- History Page -->
                <div class="page" id="historyPage">
                    <div class="queue-section">
                        <div class="section-header">
                            <h2 class="section-title">ประวัติการให้บริการวันนี้</h2>
                        </div>

                        <table class="queue-table">
                            <thead>
                                <tr>
                                    <th>หมายเลขคิว</th>
                                    <th>ชื่อผู้ป่วย</th>
                                    <th>HN</th>
                                    <th>ประเภท</th>
                                    <th>เวลาเริ่ม</th>
                                    <th>เวลาเสร็จ</th>
                                    <th>ระยะเวลา</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- History items will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- New Patient Detail Page -->
                <div class="page" id="patientDetailPage">
                    <div class="detail-grid-container">
                        <!-- Section 1: Action Panel -->
                        <div class="detail-actions-panel">
                            <div class="action-btn-group" id="initial-actions">
                                <button class="btn-action">เรียกซ้ำ</button>
                                <button class="btn-action">ปล่อยคิว</button>
                                <button class="btn-action btn-call">เริ่มให้บริการ</button>
                                <button class="btn-action">เจาะเลือดยาก</button>
                            </div>
                            <div class="action-btn-group" id="in-service-actions" style="display: none;">
                                <button class="btn-action">สำเร็จ</button>
                                <button class="btn-action">รอเรียกใหม่</button>
                                <button class="btn-action">ปิดคิว</button>
                                <button class="btn-action">Labelling</button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
                                <div class="channel-display">
                                    <div class="label">ช่องบริการ</div>
                                    <div class="value" id="detail-channel">-</div>
                                </div>
                                <div class="timer-display">
                                    <div class="label">ระยะเวลา</div>
                                    <div class="value" id="detail-timer">00:00:00</div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Patient Info -->
                        <div class="detail-patient-info">
                            <h3>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                ข้อมูลผู้ป่วย
                            </h3>
                            <img id="detail-patient-photo" class="patient-photo-new" src="" alt="Patient Photo">
                            <div class="patient-info-grid-new">
                                <div class="info-item"><div class="label">คิวที่</div><div class="value" id="detail-queue-no">-</div></div>
                                <div class="info-item"><div class="label">ประเภท</div><div class="value" id="detail-type">-</div></div>
                                <div class="info-item"><div class="label">HN</div><div class="value" id="detail-hn">-</div></div>
                                <div class="info-item"><div class="label">เพศ</div><div class="value" id="detail-sex">-</div></div>
                                <div class="info-item"><div class="label">อายุ</div><div class="value" id="detail-age">-</div></div>
                                <div class="info-item"><div class="label">วอร์ด</div><div class="value" id="detail-ward">-</div></div>
                                <div class="info-item"><div class="label">สิทธิ์</div><div class="value" id="detail-right">-</div></div>
                                <div class="info-item"><div class="label">แผนก</div><div class="value" id="detail-department">-</div></div>
                                <div class="info-item"><div class="label">สัญชาติ</div><div class="value" id="detail-nationality">-</div></div>
                                <div class="info-item"><div class="label">หมายเหตุ</div><div class="value" id="detail-notes">-</div></div>
                            </div>
                        </div>

                        <!-- Section 3: Blood Test List -->
                        <div class="detail-tube-list">
                             <h3>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                                รายการเจาะเลือด
                            </h3>
                            <div id="detail-tube-list-content"></div>
                        </div>

                        <!-- Section 4 & 5: Meta Info -->
                        <div class="detail-meta-info">
                            <div class="meta-section">
                                <h3>ข้อมูลการตรวจ</h3>
                                <div class="meta-grid">
                                    <div class="info-item"><div class="label">เวลาที่กดคิว</div><div class="value" id="detail-call-time">-</div></div>
                                    <div class="info-item"><div class="label">เวลาเป้าหมาย</div><div class="value" id="detail-target-time">-</div></div>
                                    <div class="info-item"><div class="label">ระยะเวลา</div><div class="value" id="detail-duration">-</div></div>
                                    <div class="info-item"><div class="label">Target</div><div class="value">00:30:00</div></div>
                                </div>
                            </div>
                            <div class="meta-section">
                                <h3>ข้อมูลการชำระเงิน</h3>
                                <div class="meta-grid">
                                    <div class="info-item"><div class="label">Billing No</div><div class="value" id="detail-billing-no">-</div></div>
                                    <div class="info-item"><div class="label">Billing Date</div><div class="value" id="detail-billing-date">-</div></div>
                                    <div class="info-item"><div class="label">เริ่มให้บริการ</div><div class="value" id="detail-service-start">-</div></div>
                                    <div class="info-item"><div class="label">ผลการเจาะเก็บ</div><div class="value" id="detail-draw-outcome">-</div></div>
                                    <div class="info-item"><div class="label">ผู้ให้บริการ</div><div class="value" id="detail-provider">-</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

        <script>
            // Mock data
            const typeLabels = {
                general: 'ทั่วไป',
                wheelchair: 'รถเข็น',
                urgent: 'เร่งด่วน',
                container: 'กระปุก'
            };
    
            const statusLabels = {
                waiting: 'รอเรียก',
                called: 'เรียกแล้ว',
                serving: 'กำลังให้บริการ',
                completed: 'เสร็จสิ้น'
            };
    
                    let queueData = [
                        { 
                            id: 'A032', name: 'นางสาวสมหญิง รักดี', hn: 'HN123456', type: 'general', status: 'waiting', time: '08:30', sex: 'หญิง', age: '34 ปี', ward: 'OPD Med', right: 'ประกันสังคม', notes: 'แพ้ยา Penicillin', photo: 'https://randomuser.me/api/portraits/women/68.jpg', 
                            tubes: [
                                { id: 1, color: 'red', name: '🔴 Red Top', volume: '5 mL', tests: 'Chemistry', details: 'ตรวจเคมีในเลือดทั่วไป', additives: ['Clot Activator'], scanned: false },
                                { id: 2, color: 'purple', name: '🟣 Lavender Top', volume: '3 mL', tests: 'CBC', details: 'ตรวจความสมบูรณ์ของเม็ดเลือด', additives: ['EDTA'], scanned: false }
                            ]
                        },
                        { 
                            id: 'U005', name: 'นายประชา สุขใจ', hn: 'HN234567', type: 'urgent', status: 'waiting', time: '08:35', sex: 'ชาย', age: '51 ปี', ward: 'OPD Sur', right: 'ข้าราชการ', notes: '-', photo: 'https://randomuser.me/api/portraits/men/43.jpg', 
                            tubes: [
                                { id: 3, color: 'light-blue', name: '🔵 Light Blue Top', volume: '2.7 mL', tests: 'Coagulation (PT, PTT)', details: 'ตรวจการแข็งตัวของเลือด', additives: ['Sodium Citrate'], scanned: false }
                            ]
                        },
                        { 
                            id: 'A033', name: 'นางสาววรรณา มีสุข', hn: 'HN345678', type: 'general', status: 'serving', time: '08:40', sex: 'หญิง', age: '28 ปี', ward: 'OPD Med', right: 'ชำระเงินเอง', notes: '-', photo: 'https://randomuser.me/api/portraits/women/44.jpg', calledByStaff: 'admin', calledByCounter: 1, serviceStartTime: new Date(Date.now() - 5 * 60000).toISOString(), 
                            tubes: [
                                { id: 4, color: 'red', name: '🔴 Red Top', volume: '5 mL', tests: 'Chemistry, BUN, Creatinine', details: 'ตรวจการทำงานของไต', additives: ['Clot Activator'], scanned: true },
                                { id: 5, color: 'green', name: '🟢 Green Top', volume: '4 mL', tests: 'Ammonia', details: 'ตรวจระดับแอมโมเนีย', additives: ['Lithium Heparin'], scanned: false }
                            ]
                        },
                        { 
                            id: 'W002', name: 'นายสมชาย ใจดี', hn: 'HN456789', type: 'wheelchair', status: 'waiting', time: '08:45', sex: 'ชาย', age: '65 ปี', ward: 'IPD 1A', right: 'บัตรทอง', notes: 'ผู้ป่วยติดเตียง', photo: 'https://randomuser.me/api/portraits/men/46.jpg', 
                            tubes: [
                                { id: 6, color: 'yellow', name: '🟡 Yellow Top', volume: '8.5 mL', tests: 'Blood Culture', details: 'เพาะเชื้อในกระแสเลือด', additives: ['SPS'], scanned: false }
                            ]
                        }
                    ];    
            let historyData = [
            { id: 'A025', name: 'นายทดสอบ ระบบหนึ่ง', hn: 'HN998877', type: 'general', startTime: '07:30', endTime: '07:40', duration: '10 นาที' },
            { id: 'U004', name: 'นางสาวอรอุมา ดีเลิศ', hn: 'HN333333', type: 'urgent', startTime: '07:35', endTime: '07:42', duration: '7 นาที' },
            { id: 'A026', name: 'นายสมศักดิ์ มั่งคั่ง', hn: 'HN222222', type: 'general', startTime: '07:41', endTime: '07:55', duration: '14 นาที' },
            { id: 'W001', name: 'นางพิมพ์ใจ สุขสันต์', hn: 'HN111111', type: 'wheelchair', startTime: '07:45', endTime: '08:00', duration: '15 นาที' },
            { id: 'A028', name: 'นายเดชา พลเยี่ยม', hn: 'HN887766', type: 'general', startTime: '08:01', endTime: '08:10', duration: '9 นาที' },
            { id: 'A029', name: 'นางสาวนารีรัตน์ จิตใส', hn: 'HN776655', type: 'general', startTime: '08:05', endTime: '08:14', duration: '9 นาที' },
            { id: 'C007', name: 'นายมานะ ส่งตรวจ', hn: 'HN665544', type: 'container', startTime: '08:10', endTime: '08:15', duration: '5 นาที' },
            { id: 'A030', name: 'นายวิชัย เก่งกาจ', hn: 'HN678901', type: 'general', startTime: '08:15', endTime: '08:25', duration: '10 นาที' },
            { id: 'A031', name: 'นายธนพล สินมั่นคง', hn: 'HN789012', type: 'general', startTime: '08:20', endTime: '08:31', duration: '11 นาที' },
            { id: 'U005', name: 'นายเก่งกาจ ชนะภัย', hn: 'HN554433', type: 'urgent', startTime: '08:22', endTime: '08:29', duration: '7 นาที' },
            { id: 'A042', name: 'นางสาวพรทิพย์ ใจงาม', hn: 'HN443322', type: 'general', startTime: '08:32', endTime: '08:40', duration: '8 นาที' },
            { id: 'A043', name: 'นายวีระพล แข็งแรง', hn: 'HN332211', type: 'general', startTime: '08:35', endTime: '08:45', duration: '10 นาที' },
            { id: 'W004', name: 'นางสมศรี มีชัย', hn: 'HN221100', type: 'wheelchair', startTime: '08:40', endTime: '08:55', duration: '15 นาที' },
            { id: 'A044', name: 'นายอดิศักดิ์ รุ่งเรือง', hn: 'HN110099', type: 'general', startTime: '08:46', endTime: '08:56', duration: '10 นาที' },
            { id: 'A045', name: 'นางสาวปิยะพร สุขเกษม', hn: 'HN009988', type: 'general', startTime: '08:50', endTime: '09:00', duration: '10 นาที' }
        ];
            let currentUser = null;
            let currentCounter = 1;
            let serviceTimer = null;
    
            // --- Core Functions ---
            function handleLogin(event) {
                event.preventDefault();
                const username = document.getElementById('username').value;
                if (username) {
                    currentUser = { name: username, counter: 1 };
                    document.getElementById('userName').textContent = username;
                    document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    renderQueue();
                    renderHistory();
                    updateStats();
                }
            }
    
            function handleLogout() {
                if (confirm('คุณต้องการออกจากระบบหรือไม่?')) {
                    currentUser = null;
                    document.getElementById('dashboard').classList.remove('active');
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                }
            }
    
            function showPage(pageId) {
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('onclick').includes(pageId)) {
                        item.classList.add('active');
                    }
                });
            }
    
            function backToQueue() {
                showPage('queuePage');
            }
    
            // --- Queue Page Functions ---
            function filterQueue(buttonElement, status) {
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                buttonElement.classList.add('active');
                renderQueue(status);
            }
    
            function renderQueue(statusFilter = 'all') {
                const tbody = document.getElementById('queueTableBody');
                tbody.innerHTML = '';
                let filteredData = (statusFilter !== 'all') ? queueData.filter(q => q.status === statusFilter) : [...queueData];
                
                const statusOrder = { 'waiting': 1, 'serving': 2, 'completed': 3 };
                filteredData.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99) || a.time.localeCompare(b.time));
    
                filteredData.forEach(queue => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="queue-number">${queue.id}</span></td>
                        <td>${queue.name}</td>
                        <td>${queue.hn}</td>
                        <td><span class="type-badge ${queue.type}">${typeLabels[queue.type]}</span></td>
                        <td><span class="status-badge ${queue.status}">${statusLabels[queue.status]}</span></td>
                        <td>${queue.time}</td>
                        <td>${queue.calledByCounter || '-'}</td>
                        <td>${queue.calledByStaff || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                ${queue.status === 'waiting' ? `<button class="btn-action btn-call" onclick="callQueue('${queue.id}')">เรียกคิว</button>` : ''}
                                <button class="btn-action btn-view" onclick="viewPatient('${queue.id}')">ดูข้อมูล</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
    
            function callQueue(queueId) {
                const queue = queueData.find(q => q.id === queueId);
                if (queue) {
                    queue.status = 'serving';
                    queue.calledByStaff = currentUser.name;
                    queue.calledByCounter = currentCounter;
                    queue.queueCallTime = new Date().toLocaleString('th-TH');
                    const target = new Date();
                    target.setMinutes(target.getMinutes() + 30);
                    queue.targetTime = target.toLocaleString('th-TH');
                    renderQueue();
                    updateStats();
                    viewPatient(queueId);
                }
            }
    
            function updateStats() {
                document.getElementById('statGeneral').textContent = queueData.filter(q => q.type === 'general' && q.status !== 'completed').length;
                document.getElementById('statWheelchair').textContent = queueData.filter(q => q.type === 'wheelchair' && q.status !== 'completed').length;
                document.getElementById('statUrgent').textContent = queueData.filter(q => q.type === 'urgent' && q.status !== 'completed').length;
                document.getElementById('statContainer').textContent = queueData.filter(q => q.type === 'container' && q.status !== 'completed').length;
            }
    
                    function renderHistory() {
                        const tbody = document.getElementById('historyTableBody');
                        tbody.innerHTML = '';
                        historyData.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><span class="queue-number">${item.id}</span></td>
                                <td>${item.name}</td>
                                <td>${item.hn}</td>
                                <td><span class="type-badge ${item.type}">${typeLabels[item.type]}</span></td>
                                <td>${item.startTime}</td>
                                <td>${item.endTime}</td>
                                <td>${item.duration}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
            
                    // --- Patient Detail Page Functions ---
                    function viewPatient(queueId) {
                        const queue = queueData.find(q => q.id === queueId);
                        if (!queue) return;
            
                        window.currentPatientQueueId = queueId;
                        stopServiceTimer();
                        document.getElementById('detail-timer').textContent = '00:00:00';
            
                        const isServing = queue.serviceStartTime != null;
                        document.getElementById('initial-actions').style.display = isServing ? 'none' : 'flex';
                        document.getElementById('in-service-actions').style.display = isServing ? 'flex' : 'none';
                        if(isServing) startServiceTimer(queue.serviceStartTime);
            
                        document.getElementById('detail-channel').textContent = queue.calledByCounter || '-';
                        document.getElementById('detail-patient-photo').src = queue.photo;
                        document.getElementById('detail-queue-no').textContent = queue.id;
                        document.getElementById('detail-type').textContent = typeLabels[queue.type] || '-';
                        document.getElementById('detail-hn').textContent = queue.hn;
                        document.getElementById('detail-sex').textContent = queue.sex || '-';
                        document.getElementById('detail-age').textContent = queue.age || '-';
                        document.getElementById('detail-ward').textContent = queue.ward || '-';
                        document.getElementById('detail-right').textContent = queue.right || '-';
                        document.getElementById('detail-department').textContent = queue.department || '-';
                        document.getElementById('detail-nationality').textContent = queue.nationality || '-';
                        document.getElementById('detail-notes').textContent = queue.notes || '-';
                        
                        renderTubeList(queue.tubes);
            
                        document.getElementById('detail-call-time').textContent = queue.queueCallTime || '-';
                        document.getElementById('detail-target-time').textContent = queue.targetTime || '-';
                        document.getElementById('detail-duration').textContent = '00:00:00';
                        document.getElementById('detail-billing-no').textContent = queue.billingNo || '-';
                        document.getElementById('detail-billing-date').textContent = queue.billingDate || '-';
                        document.getElementById('detail-service-start').textContent = queue.serviceStartTime ? new Date(queue.serviceStartTime).toLocaleString('th-TH') : '-';
                        document.getElementById('detail-draw-outcome').textContent = queue.drawOutcome || '-';
                        document.getElementById('detail-provider').textContent = queue.calledByStaff || '-';
            
                        showPage('patientDetailPage');
                    }    
                    function renderTubeList(tubes = []) {
                        const tubeContent = document.getElementById('detail-tube-list-content');
                        if (!tubes || tubes.length === 0) {
                            tubeContent.innerHTML = '<p style="text-align: center; color: #718096;">ไม่มีรายการเจาะเลือดสำหรับผู้ป่วยรายนี้</p>';
                            return;
                        }
                        tubeContent.innerHTML = '<div class="tubes-list">' + tubes.map(tube => `
                            <div class="tube-item">
                                <div class="tube-visual-wrapper">
                                    <div class="tube-visual">
                                        <div class="tube-icon-horizontal ${tube.color}">
                                            <div class="tube-cap-horizontal"></div>
                                        </div>
                                    </div>
                                    <div class="tube-actions">
                                        <span class="tube-action-icon" onclick="alert('พิมพ์สติ๊กเกอร์สำหรับหลอด ${tube.name}')" title="พิมพ์สติ๊กเกอร์">🖨️</span>
                                        <span class="tube-action-icon ${tube.scanned ? 'scanned' : ''}" onclick="scanTube(${tube.id})" title="สแกนหลอดเลือด">✔️</span>
                                    </div>
                                </div>
                                <div class="tube-content">
                                    <div class="tube-header">
                                        <span class="tube-name-detail">${tube.name}</span>
                                        <span class="tube-volume">${tube.volume}</span>
                                    </div>
                                    <div class="tube-test-name">${tube.tests}</div>
                                    <div class="tube-details">${tube.details}</div>
                                    <div class="tube-additives">
                                        ${tube.additives.map(tag => `<span class="additive-tag">${tag}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('') + '</div>';
                    }    
            function scanTube(tubeId) {
                const queue = queueData.find(q => q.id === window.currentPatientQueueId);
                const tube = queue.tubes.find(t => t.id === tubeId);
                if (tube) {
                    tube.scanned = !tube.scanned;
                    renderTubeList(queue.tubes);
                }
            }
    
            function startServiceTimer(startTime) {
                stopServiceTimer();
                const timerElement = document.getElementById('detail-timer');
                const start = new Date(startTime);
                serviceTimer = setInterval(() => {
                    const diff = new Date() - start;
                    const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                    const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                    const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                    const timeString = `${h}:${m}:${s}`;
                    timerElement.textContent = timeString;
                    document.getElementById('detail-duration').textContent = timeString;
                }, 1000);
            }
    
            function stopServiceTimer() {
                clearInterval(serviceTimer);
            }
    
            function startService() {
                const queue = queueData.find(q => q.id === window.currentPatientQueueId);
                if (!queue) return;
                alert('เริ่มให้บริการและดำเนินการพิมพ์ Label');
                queue.serviceStartTime = new Date().toISOString();
                viewPatient(queue.id);
            }
    
            function releaseQueue() {
                const queue = queueData.find(q => q.id === window.currentPatientQueueId);
                if (queue && confirm(`ยืนยันปล่อยคิว ${queue.id} (${queue.name}) กลับไปรอเรียก?`)) {
                    queue.status = 'waiting';
                    queue.calledByStaff = null;
                    queue.calledByCounter = null;
                    queue.queueCallTime = null;
                    queue.serviceStartTime = null;
                    stopServiceTimer();
                    renderQueue();
                    backToQueue();
                }
            }
    
                    function completeService() {
                        stopServiceTimer();
                        const queue = queueData.find(q => q.id === window.currentPatientQueueId);
                        if (queue && confirm(`ยืนยันการให้บริการเสร็จสิ้นสำหรับคิว ${queue.id}?`)) {
                            queue.status = 'completed';
                            queue.drawOutcome = 'สำเร็จ';
                            
                            // Add to history
                            const now = new Date();
                            const endTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                            const duration = document.getElementById('detail-duration').textContent;
            
                            historyData.unshift({ // Add to the top of the history
                                id: queue.id,
                                name: queue.name,
                                hn: queue.hn,
                                type: queue.type,
                                startTime: new Date(queue.serviceStartTime).toLocaleTimeString('th-TH'),
                                endTime: endTime,
                                duration: duration
                            });
            
                            renderQueue();
                            renderHistory(); // Call the render function
                            updateStats();
                            backToQueue();
                        }
                    }    
            function cancelQueue() {
                const queueIndex = queueData.findIndex(q => q.id === window.currentPatientQueueId);
                if (queueIndex > -1 && confirm(`ต้องการลบรายการของ ${queueData[queueIndex].name} ออกจากระบบใช่หรือไม่?`)) {
                    queueData.splice(queueIndex, 1);
                    renderQueue();
                    backToQueue();
                }
            }
    
            function recallPatient() { alert('เรียกผู้ป่วยซ้ำ'); }
            function difficultDraw() { alert('บันทึกว่าเป็นเคสเจาะเลือดยาก'); }
            function recallNew() { alert('แสดงหน้าต่างสำหรับบันทึกเหตุผลและรอเรียกใหม่'); }
            function labelling() { alert('พิมพ์ Label ซ้ำ'); }
    
            // --- Init & Event Listeners ---
            window.addEventListener('DOMContentLoaded', () => {
                document.querySelector('#initial-actions button:nth-child(1)').onclick = recallPatient;
                document.querySelector('#initial-actions button:nth-child(2)').onclick = releaseQueue;
                document.querySelector('#initial-actions button:nth-child(3)').onclick = startService;
                document.querySelector('#initial-actions button:nth-child(4)').onclick = difficultDraw;
                document.querySelector('#in-service-actions button:nth-child(1)').onclick = completeService;
                document.querySelector('#in-service-actions button:nth-child(2)').onclick = recallNew;
                document.querySelector('#in-service-actions button:nth-child(3)').onclick = cancelQueue;
                document.querySelector('#in-service-actions button:nth-child(4)').onclick = labelling;
                document.getElementById('username').value = 'admin';
                document.getElementById('password').value = 'admin';
            });
        </script>